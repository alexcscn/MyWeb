"use strict";(function(b,a){if(typeof define==="function"&&define.amd){define([],a)}else{if(typeof module!=="undefined"&&module.exports){module.exports=a()}else{b.CCFsm=a()}}})(this,function(){function a(){var b=this;b.FSMID_ERROR=4294967295;b.CC_IDLE=0;b.CC_WAIT_SETUPACK=1;b.CC_WAIT_CONN=2;b.CC_WAIT_USER_CONN=3;b.CC_WAIT_CONNACK=4;b.CC_RUNNING=5;b.CPTM_CC_SETUPACK_LEN=6000;b.CPTM_CC_CONN_LEN=90000;b.CPTM_CC_ANSWER_LEN=90000;b.CPTM_CC_CONNACK_LEN=6000;b.CPTM_CC_HB_LEN=5000;b.CPTM_CC_PRESS_LEN=1000;b.uiMyId=b.FSMID_ERROR;b.bInit=false;b.UserCtx=null;b.PeerConn=null;b.bPeerConnAnswer=false;b.MySdp=null;b.PeerSdp=null;b.uiPeerFsmId=b.FSMID_ERROR;b.uiPrio=7;b.strMyNum=null;b.strPeerNum=null;b.strOrigCalledNum=null;b.strDispNum=null;b.strstDispName=null;b.SrvType=null;b.bConnected=false;b.ucARx=0;b.ucATx=0;b.ucVRx=0;b.ucVTx=0;b.idLocalV=null;b.idPeerV=null;b.SetPeerSdp=false;b.tmp_strPwd=null;b.tmp_ucCallOut=0;b.tmp_ucDelG=0;b.iHBCount=0;b.TimerHB=null;b.bIsGCall=false;b.bUserNotify=false;b.bUserWantMic=false;b.ucLastMicReq=0;b.ucLastMic=0;b.strTalkingNum=null;b.strTalkingName=null;b.TimerPress=null;b.bPressUserWant=false;b.State=0;b.TimerState=null;b.Init=function(){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Init");b.ClearRun();return 0};b.ClearRun=function(){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"ClearRun");if(null!=b.TimerState){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Stop TimerState");clearTimeout(b.TimerState);b.TimerState=null}if(null!=b.TimerPress){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Stop TimerPress");clearTimeout(b.TimerPress);b.TimerPress=null}if(null!=b.TimerHB){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Stop TimerHB");clearTimeout(b.TimerHB);b.TimerHB=null}if(null!=b.idLocalV){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"idLocalV.srcObject=null");b.idLocalV.srcObject=null;b.idLocalV=null}if(null!=b.idPeerV){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"idPeerV.srcObject=null");b.idPeerV.srcObject=null;b.idPeerV=null}if(b.PeerConn){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Release PeerConn");b.PeerConn.close();b.PeerConn=null}b.bInit=false;b.UserCtx=null;b.PeerConn=null;b.bPeerConnAnswer=false;b.MySdp=null;b.PeerSdp=null;b.uiPeerFsmId=b.FSMID_ERROR;b.uiPrio=7;b.strMyNum=null;b.strPeerNum=null;b.strOrigCalledNum=null;b.strDispNum=null;b.strstDispName=null;b.SrvType=null;b.bConnected=false;b.ucARx=0;b.ucATx=0;b.ucVRx=0;b.ucVTx=0;b.idLocalV=null;b.idPeerV=null;b.SetPeerSdp=false;b.tmp_strPwd=null;b.tmp_ucCallOut=0;b.tmp_ucDelG=0;b.iHBCount=0;b.TimerHB=null;b.bIsGCall=false;b.bUserNotify=false;b.bUserWantMic=false;b.ucLastMicReq=0;b.ucLastMic=0;b.strTalkingNum=null;b.strTalkingName=null;b.TimerPress=null;b.bPressUserWant=false;b.State=0;b.TimerState=null;return 0};b.Rel=function(d,f){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Rel",IDT.GetCloseStr(d),":",IDT.GetCauseStr(f));if(false==b.bInit){return 0}var e=0,c=0;switch(d){case IDT.CLOSE_BYPEER:c=1;break;case IDT.CLOSE_BYUSER:e=1;break;case IDT.CLOSE_BYINNER:e=1;c=1;break;default:break}if(e){m_IdtApi.McLink.SendJson({MsgCode:IDT.MSG_CC_REL,SrcFsm:b.uiMyId,DstFsm:b.uiPeerFsmId,MsgBody:{Cause:f}})}if(c){if(null!=m_IdtApi.CallBack.onCallInd){m_IdtApi.CallBack.onCallInd(IDT.CALL_EVENT_Rel,b.UserCtx,d,f)}}b.ClearRun();return 0};b.SetMedia=function(f,j,m,d,n,k,i){b.ucARx=f;b.ucATx=j;b.ucVRx=m;b.ucVTx=d;b.idLocalV=n;b.idPeerV=k;if(IDT.SRV_TYPE_WATCH_DOWN==i){if(null!=b.idPeerV){try{b.idPeerV.volume=0}catch(h){}}}else{if(null!=b.idPeerV){try{b.idPeerV.volume=1}catch(h){}}}if(1==b.ucVTx){b.idLocalV.srcObject=m_IdtApi.LocalStream}var l={iceServers:[{urls:m_IdtApi.strStunServer}]};PUtility.Log(" ",PUtility.PGetCurTime(),"self.PeerConn = new RTCPeerConnection(servers)");b.PeerConn=new RTCPeerConnection(l);var g=m_IdtApi.LocalStream.getVideoTracks();var c=m_IdtApi.LocalStream.getAudioTracks();if((f||j)&&(null!=b.PeerConn)){PUtility.Log(" ",PUtility.PGetCurTime(),"Added Audio stream to LocalConn");b.PeerConn.addTrack(c[0],m_IdtApi.LocalStream)}if((m||d)&&(null!=b.PeerConn)){PUtility.Log(" ",PUtility.PGetCurTime(),"Added Video stream to LocalConn");b.PeerConn.addTrack(g[0],m_IdtApi.LocalStream)}b.PeerConn.onicecandidate=function(e){b.onIceCandidate(b,e)};b.PeerConn.oniceconnectionstatechange=function(e){b.onIceStateChange(b,e)};b.PeerConn.ontrack=function(e){b.onTrack(b,e)};PUtility.Log(" ",PUtility.PGetCurTime(),"self.PeerConn.createOffer()");b.PeerConn.createOffer().then(b.onCreateOfferSuccess,b.onCreateOfferError);return 0};b.SdpFilter=function(h,g,k,c){if(0==g){return true}if(-1!=h.indexOf("a=extmap:")){return false}var f=new Array();f[0]={str:"a=rtpmap:",len:9};f[1]={str:"a=rtcp-fb:",len:10};f[2]={str:"a=fmtp:",len:7};var e,d=-1;for(e=0;e<f.length;e++){if(-1!=h.indexOf(f[e].str)){d=e;break}}if(-1==d){f=null;return true}var j=parseInt(h.substring(f[d].len));switch(g){case 1:if(j==0||j==k){f=null;return true}break;case 2:if(j==c){f=null;return true}break;default:f=null;return true}f=null;return false};b.FormatSdp=function(g,h,q,t,f,p,l){var o=126;var c=100;if(h||q){o=-1}if(t||f){c=-1}var m=g.split("\r\n");if(m.length<=1){return""}var j;var n;for(j=0;j<m.length-1;j++){if(-1==o){if(-1==m[j].indexOf("telephone-event/8000")){continue}o=parseInt(m[j].substring(9))}if(-1==c){if(-1==m[j].indexOf("profile-level-id=42e01f")){continue}c=parseInt(m[j].substring(7))}if(-1!=o&&-1!=c){break}}var e=0;var k,r,s;var d="";for(j=0;j<m.length-1;j++){if(-1!=m[j].indexOf("m=audio")){e=1;d+="m=audio 9 UDP/TLS/RTP/SAVPF 0 ";d+=o;d+="\r\n";continue}if(-1!=m[j].indexOf("m=video")){e=2;d+="m=video 9 UDP/TLS/RTP/SAVPF ";d+=c;d+="\r\n";continue}if(false==b.SdpFilter(m[j],e,o,c)){continue}if(-1==m[j].indexOf("a=sendrecv")){d+=m[j];d+="\r\n";continue}switch(e){case 1:if(IDT.SRV_TYPE_CONF==p||IDT.SRV_TYPE_CONF_JOIN==p){d+="a=sendrecv\r\n"}else{if(1==h&&1==q){d+="a=sendrecv\r\n"}else{if(1==h&&0==q){d+="a=recvonly\r\n"}else{if(0==h&&1==q){d+="a=sendonly\r\n"}}}}break;case 2:if(IDT.SRV_TYPE_CONF==p||IDT.SRV_TYPE_CONF_JOIN==p){if(false==l){d+="a=sendrecv\r\n"}}else{if(1==t&&1==f){d+="a=sendrecv\r\n"}else{if(1==t&&0==f){d+="a=recvonly\r\n"}else{if(0==t&&1==f){d+="a=sendonly\r\n"}}}}break;default:break}}return d};b.onCreateOfferError=function(c){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onCreateOfferError",c)};b.onSetLocalSuccess=function(c){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onSetLocalSuccess:",c)};b.onSetLocalError=function(c){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onSetLocalError",c)};b.onSetRemoteSuccess=function(){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onSetRemoteSuccess:")};b.onSetRemoteError=function(c){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onSetRemoteError",c)};b.onIceStateChange=function(d,c){if(null==b.PeerConn){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onIceLocalStateChange:",c)}else{PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onIceLocalStateChange:",c,b.PeerConn.iceConnectionState)}};b.onAddIcePeerCandidateSuccess=function(c){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onAddIcePeerCandidateSuccess:",c)};b.onAddIcePeerCandidateError=function(d,c){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onAddIcePeerCandidateError:",d,c)};b.onIceCandidate=function(e,d){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onIceCandidate:",d);if(null==d.candidate){return}return;var c=JSON.stringify(d.candidate);b.UserSendInfo(IDT.SRV_INFO_ICECAND,c)};b.onCreateOfferSuccess=function(c){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onCreateOfferSuccess:",c);c.sdp=b.FormatSdp(c.sdp,b.ucARx,b.ucATx,b.ucVRx,b.ucVTx,b.SrvType,b.bIsGCall);PUtility.Log(" ",PUtility.PGetCurTime(),"self.PeerConn.setLocalDescription",c.sdp);b.PeerConn.setLocalDescription(c).then(function(){b.onSetLocalSuccess(c)},b.onSetLocalError);b.MySdp=c;var d;if(b.CC_WAIT_SETUPACK==b.State){d={MsgCode:IDT.MSG_CC_SETUP,SrcFsm:b.uiMyId,DstFsm:b.FSMID_ERROR,MsgBody:{MyNum:b.strMyNum,PeerNum:b.strPeerNum,OrigCalledNum:b.strOrigCalledNum,SrvType:b.SrvType,MySdp:{ARx:b.ucARx,ATx:b.ucATx,VRx:b.ucVRx,VTx:b.ucVTx,SdpStrType:b.MySdp.type,SdpStr:b.MySdp.sdp},CallConf:{Pwd:b.tmp_strPwd,CallOut:b.tmp_ucCallOut,DelG:b.tmp_ucDelG}}};if(IDT.SRV_TYPE_CONF==b.SrvType){if(0==b.ucARx){d.MsgBody.CallConf.MicNum1=1;d.MsgBody.CallConf.Audio1=1;d.MsgBody.CallConf.VideoTx1=0;d.MsgBody.CallConf.VideoRx1=0;d.MsgBody.CallConf.MicNum2=0;d.MsgBody.CallConf.Audio2=0;d.MsgBody.CallConf.VideoTx2=0;d.MsgBody.CallConf.VideoRx2=0;d.MsgBody.CallConf.AutoMic=0;b.bIsGCall=true}else{d.MsgBody.CallConf.MicNum1=1;d.MsgBody.CallConf.Audio1=1;d.MsgBody.CallConf.VideoTx1=1;d.MsgBody.CallConf.VideoRx1=1;d.MsgBody.CallConf.MicNum2=16;d.MsgBody.CallConf.Audio2=1;d.MsgBody.CallConf.VideoTx2=1;d.MsgBody.CallConf.VideoRx2=0;d.MsgBody.CallConf.AutoMic=0;b.bIsGCall=false}}else{d.MsgBody.CallConf.MicNum1=0;d.MsgBody.CallConf.Audio1=0;d.MsgBody.CallConf.VideoTx1=0;d.MsgBody.CallConf.VideoRx1=0;d.MsgBody.CallConf.MicNum2=0;d.MsgBody.CallConf.Audio2=0;d.MsgBody.CallConf.VideoTx2=0;d.MsgBody.CallConf.VideoRx2=0;d.MsgBody.CallConf.AutoMic=0;b.bIsGCall=false}}else{d={MsgCode:IDT.MSG_CC_CONN,SrcFsm:b.uiMyId,DstFsm:b.uiPeerFsmId,MsgBody:{MySdp:{ARx:b.ucARx,ATx:b.ucATx,VRx:b.ucVRx,VTx:b.ucVTx,SdpStrType:b.MySdp.type,SdpStr:b.MySdp.sdp}}}}m_IdtApi.McLink.SendJson(d)};b.onTrack=function(d,c){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"onTrack:",c);if(IDT.SRV_TYPE_CONF==b.SrvType||IDT.SRV_TYPE_CONF_JOIN==b.SrvType){if(b.idPeerV.srcObject!==c.streams[0]){b.idPeerV.srcObject=c.streams[0];PUtility.Log(PUtility.PGetCurTime(),"onTrack:",b.idPeerV)}}else{if(1==b.ucARx||1==b.ucVRx){if(b.idPeerV.srcObject!==c.streams[0]){b.idPeerV.srcObject=c.streams[0];PUtility.Log(PUtility.PGetCurTime(),"onTrack:",b.idPeerV)}}}};b.SdpGetMyAttrFromPeer=function(d,c){c.ARx=0;c.ATx=0;c.VRx=0;c.VTx=0;if(1==d.ARx){c.ATx=1}if(1==d.ATx){c.ARx=1}if(1==d.VRx){c.VTx=1}if(1==d.VTx){c.VRx=1}return 0};b.CallMakeOut=function(l,o,m,f,j,n,e,g,d,i,c,h,k){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"CallMakeOut",g,d,i,f,j,n,e,l,c,h,k,o,m);b.UserCtx=l;b.PeerConn=null;b.MySdp=null;b.PeerSdp=null;b.uiPeerFsmId=b.FSMID_ERROR;b.uiPrio=null;b.strMyNum=g;b.strPeerNum=d.split("*")[0];b.strOrigCalledNum=d;b.strDispNum=null;b.strstDispName=null;b.SrvType=i;b.bConnected=false;b.tmp_strPwd=c;b.tmp_ucCallOut=h;b.tmp_ucDelG=k;b.iHBCount=0;b.TimerHB=null;b.bIsGCall=null;b.bUserNotify=null;b.bUserWantMic=null;b.ucLastMicReq=null;b.ucLastMic=null;b.strTalkingNum=null;b.strTalkingName=null;b.TimerPress=null;b.bPressUserWant=null;switch(i){case IDT.SRV_TYPE_CONF:b.bUserNotify=true;b.bUserWantMic=true;b.bPressUserWant=true;b.ucLastMicReq=IDT.SRV_INFO_MICREQ;if(0==f){b.bIsGCall=true}else{b.bIsGCall=false}break;case IDT.SRV_TYPE_CONF_JOIN:b.bUserNotify=true;b.bUserWantMic=false;b.bPressUserWant=false;b.ucLastMicReq=IDT.SRV_INFO_MICNONE;b.bIsGCall=false;break;default:b.bUserNotify=false;b.bUserWantMic=false;b.bPressUserWant=false;b.ucLastMicReq=IDT.SRV_INFO_MICNONE;b.bIsGCall=false;break}b.SetMedia(f,j,n,e,o,m,b.SrvType);b.TimerState=setTimeout(b.TmSetupAck,b.CPTM_CC_SETUPACK_LEN);b.State=b.CC_WAIT_SETUPACK;return b.uiMyId};b.RecvSetupAckProc=function(c){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"RecvSetupAckProc:",c.SrcFsm);if(b.State!=b.CC_WAIT_SETUPACK){return -1}b.State=b.CC_WAIT_CONN;b.uiPeerFsmId=c.SrcFsm;clearTimeout(b.TimerState);b.TimerState=null;if(b.SRV_TYPE_CONF==b.SrvType&&b.bIsGCall){b.TimerState=setTimeout(b.TmConn,b.CCTM_CS_MICREL_LEN)}else{b.TimerState=setTimeout(b.TmConn,b.CPTM_CC_CONN_LEN)}b.TimerHB=setTimeout(b.TmHB,b.CPTM_CC_HB_LEN);b.iHBCount=0;return 0};b.SetPeerSdpFunc=function(e){var d={};b.SdpGetMyAttrFromPeer(e,d);b.ucARx=d.ARx;b.ucATx=d.ATx;b.ucVRx=d.VRx;b.ucVTx=d.VTx;var f=new RegExp("<br/>","g");var c=e.SdpStr;var g=c.replace(f,"\r\n");b.PeerSdp={type:"answer",sdp:g};if(true==b.SetPeerSdp){return 0}var h="v=0\r\n";h+="o=- 7 2 IN IP4 0.0.0.0\r\n";h+="s=-\r\n";h+="c=IN IP4 0.0.0.0\r\n";h+="t=0 0\r\n";h+="m=audio 9 UDP/TLS/RTP/SAVPF 0 126\r\n";h+="c=IN IP4 0.0.0.0\r\n";h+="a=ptime:20\r\n";h+="a=minptime:1\r\n";h+="a=maxptime:255\r\n";h+="a=rtpmap:0 PCMU/8000/1\r\n";h+="a=rtpmap:126 telephone-event/8000/1\r\n";h+="a=fmtp:126 0-16\r\n";h+="a=sendrecv\r\n";h+="a=rtcp-mux\r\n";h+="a=ssrc:2442385887 cname:IDT-CNAME-A\r\n";h+="a=ssrc:2442385887 mslabel:IDT-MSLABLE\r\n";h+="a=ssrc:2442385887 label:IDT-LABLE-A\r\n";h+="a=ice-ufrag:86OB\r\n";h+="a=ice-pwd:/8I1yH78ZWVT90mFQzN+9SQm\r\n";h+="a=ice-options:trickle\r\n";h+="a=fingerprint:sha-256 D8:2F:5E:63:F1:82:BA:F1:AE:57:AD:4A:39:CA:19:44:94:F0:D6:E6:49:73:6C:5F:E6:3E:57:59:9D:6A:B1:70\r\n";h+="a=setup:passive\r\n";h+="m=video 9 UDP/TLS/RTP/SAVPF 107\r\n";h+="c=IN IP4 0.0.0.0\r\n";h+="a=extmap:5 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01";h+="a=label:14\r\n";h+="a=content:main\r\n";h+="a=rtpmap:107 H264/90000\r\n";h+="a=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=420029\r\n";h+="a=sendrecv\r\n";h+="a=rtcp-mux\r\n";h+="a=ssrc:1822225773 cname:IDT-CNAME-V\r\n";h+="a=ssrc:1822225773 mslabel:IDT-MSLABLE\r\n";h+="a=ssrc:1822225773 label:IDT-LABLE-V\r\n";h+="a=ice-ufrag:86OB\r\n";h+="a=ice-pwd:/8I1yH78ZWVT90mFQzN+9SQm\r\n";h+="a=ice-options:trickle\r\n";h+="a=fingerprint:sha-256 D8:2F:5E:63:F1:82:BA:F1:AE:57:AD:4A:39:CA:19:44:94:F0:D6:E6:49:73:6C:5F:E6:3E:57:59:9D:6A:B1:70\r\n";h+="a=setup:passive\r\n";PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"SetPeerSdpFunc:",b.PeerSdp.sdp);b.PeerConn.setRemoteDescription(b.PeerSdp).then(b.onSetRemoteSuccess,b.onSetRemoteError);b.SetPeerSdp=true;return 0};b.RecvAlertProc=function(c){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"RecvAlertProc: ",c);b.SetPeerSdpFunc(c.MsgBody.MySdp);return 0};b.RecvConnProc=function(c){if(!(b.CC_WAIT_CONN==b.State||b.CC_RUNNING==b.State)){return -1}b.uiPeerFsmId=c.SrcFsm;b.uiPrio=c.MsgBody.Prio;b.stDispNum=c.MsgBody.TrueNum;b.stDispName=c.MsgBody.TrueName;b.SrvType=c.MsgBody.SrvType;switch(b.SrvType){case IDT.SRV_TYPE_CONF_JOIN:b.SrvType=IDT.SRV_TYPE_CONF;break;default:break}m_IdtApi.McLink.SendJson({MsgCode:IDT.MSG_CC_CONNACK,SrcFsm:b.uiMyId,DstFsm:b.uiPeerFsmId,MsgBody:{}});clearTimeout(b.TimerState);b.TimerState=null;b.State=b.CC_RUNNING;b.bConnected=true;b.SetPeerSdpFunc(c.MsgBody.MySdp);if(m_IdtApi.CallBack.onCallInd){m_IdtApi.CallBack.onCallInd(IDT.CALL_EVENT_PeerAnswer,b.UserCtx,b.stDispNum,b.stDispName,b.SrvType)}return 0};b.RecvSetupProc=function(d){b.uiPeerFsmId=d.SrcFsm;b.uiPrio=d.MsgBody.Prio;b.strPeerNum=d.MsgBody.MyNum;b.strMyNum=d.MsgBody.PeerNum;b.strDispNum=d.MsgBody.TrueNum;b.strDispName=d.MsgBody.TrueName;b.SrvType=d.MsgBody.SrvType;if(IDT.SRV_TYPE_NONE==b.SrvType){b.SrvType=IDT.SRV_TYPE_BASIC_CALL}switch(b.SrvType){case IDT.SRV_TYPE_CONF:case IDT.SRV_TYPE_CONF_JOIN:b.SrvType=IDT.SRV_TYPE_CONF;if(null!=d.MsgBody.OrigCalledName){b.strDispName=d.MsgBody.OrigCalledName}break;default:break}m_IdtApi.McLink.SendJson({MsgCode:IDT.MSG_CC_SETUPACK,SrcFsm:b.uiMyId,DstFsm:b.uiPeerFsmId,MsgBody:{}});m_IdtApi.McLink.SendJson({MsgCode:IDT.MSG_CC_ALERT,SrcFsm:b.uiMyId,DstFsm:b.uiPeerFsmId,MsgBody:{}});var c={};b.SdpGetMyAttrFromPeer(d.MsgBody.MySdp,c);if(IDT.SRV_TYPE_CONF==b.SrvType||IDT.SRV_TYPE_CONF_JOIN==b.SrvType){if(c.VRx||c.VTx){b.bIsGCall=false}else{b.bIsGCall=true}}else{b.bIsGCall=false}b.State=b.CC_WAIT_USER_CONN;b.TimerState=setTimeout(b.TmAnswer,b.CPTM_CC_ANSWER_LEN);if(m_IdtApi.CallBack.onCallInd){m_IdtApi.CallBack.onCallInd(IDT.CALL_EVENT_In,b.uiMyId,d.MsgBody.TrueNum,d.MsgBody.TrueName,b.SrvType,b.bIsGCall,c.ARx,c.ATx,c.VRx,c.VTx)}b.TimerHB=setTimeout(b.TmHB,b.CPTM_CC_HB_LEN);b.iHBCount=0;return 0};b.UserAnswer=function(i,e,d,c,g,f,h){b.UsrCtx=i;b.SetMedia(c,g,f,h,e,d,b.SrvType);clearTimeout(b.TimerState);b.TimerState=null;b.State=b.CC_WAIT_CONNACK;b.TimerState=setTimeout(b.TmConnAck,b.CPTM_CC_CONNACK_LEN);return 0};b.RecvConnAckProc=function(c){if(b.State!=b.CC_WAIT_CONNACK){return 0}clearTimeout(b.TimerState);b.TimerState=null;b.State=b.CC_RUNNING;b.bConnected=true;return 0};b.RecvRelProc=function(c){if(false==b.bInit){return 0}b.Rel(IDT.CLOSE_BYPEER,c.MsgBody.Cause);return 0};b.RecvInfoProc=function(d){m_IdtApi.McLink.SendJson({MsgCode:IDT.MSG_CC_INFOACK,SrcFsm:b.uiMyId,DstFsm:b.uiPeerFsmId,});var f;switch(d.MsgBody.Info.Info){case IDT.SRV_INFO_ICECAND:var e=new RegExp("<br/>","g");var c=d.MsgBody.Info.InfoStr;var g=c.replace(e,'"');f=JSON.parse(g);PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"RecvInfoProc-ICECAND: ",f);b.PeerConn.addIceCandidate(f).then(function(){b.onAddIcePeerCandidateSuccess(f)},function(h){b.onAddIcePeerCandidateError(f,h)});break;case IDT.SRV_INFO_SDP:b.SetPeerSdpFunc(d.MsgBody.MySdp);break;case IDT.SRV_INFO_MICINFO:if(b.strTalkingNum!=d.MsgBody.UsrNum){b.strTalkingNum=d.MsgBody.UsrNum;b.strTalkingName=d.MsgBody.UsrName;if(null==b.strTalkingNum){b.strTalkingNum=""}if(null==b.strTalkingName){b.strTalkingName=""}if(m_IdtApi.CallBack.onCallInd){m_IdtApi.CallBack.onCallInd(IDT.CALL_EVENT_TalkingIDInd,b.UsrCtx,b.strTalkingNum,b.strTalkingName)}}break;case IDT.SRV_INFO_MICREQ:case IDT.SRV_INFO_MICREL:if(m_IdtApi.CallBack.onCallInd){m_IdtApi.CallBack.onCallInd(IDT.CALL_EVENT_ConfCtrlInd,b.UsrCtx,d.MsgBody.Info.Info)}break;case IDT.SRV_INFO_TALKONRSP:break;default:if(m_IdtApi.CallBack.onCallInd){m_IdtApi.CallBack.onCallInd(IDT.CALL_EVENT_RecvInfo,b.UsrCtx,d.MsgBody.Info.Info,d.MsgBody.Info.InfoStr)}break}return 0};b.RecvInfoAckProc=function(c){return 0};b.RecvModifyProc=function(c){b.SetPeerSdpFunc(c.MsgBody.MySdp);m_IdtApi.McLink.SendJson({MsgCode:IDT.MSG_CC_MODIFYACK,SrcFsm:b.uiMyId,DstFsm:b.uiPeerFsmId,MsgBody:{OpSn:c.MsgBody.OpSn,MySdp:{ARx:b.ucARx,ATx:b.ucATx,VRx:b.ucVRx,VTx:b.ucVTx,SdpStrType:b.MySdp.type,SdpStr:b.MySdp.sdp},}});b.MicInd(false);if(IDT.SRV_TYPE_CONF==b.SrvType||IDT.SRV_TYPE_CONF_JOIN==b.SrvType){if(b.ucVRx||b.ucVTx){b.bIsGCall=false}else{b.bIsGCall=true}}else{b.bIsGCall=false}return 0};b.RecvModifyAckProc=function(c){return 0};b.UserSendInfo=function(c,d){return m_IdtApi.McLink.SendJson({MsgCode:IDT.MSG_CC_INFO,SrcFsm:b.uiMyId,DstFsm:b.uiPeerFsmId,MsgBody:{UsrNum:b.strMyNum,Info:{Info:c,InfoStr:d}}})};b.CallMicCtrl=function(c){if(false==b.bInit){return 0}if(null!=b.TimerPress){b.bPressUserWant=c;PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"bUserWantMic:",b.bUserWantMic,"bPressUserWant:",b.bPressUserWant);return 0}b.bUserNotify=true;b.bUserWantMic=c;b.bPressUserWant=c;b.ucLastMic=b.ucATx;b.MicCtrl();b.MicInd(true);b.PressTimer=setTimeout(b.TmPress,b.CPTM_CC_PRESS_LEN)};b.MicInd=function(d){if(false==b.bUserNotify){return 0}if(false==b.bConnected){return 0}var c=false;if(d){if(b.ucLastMic==b.ucATx){c=true}}else{if(2==b.ucLastMic||b.ucLastMic!=b.ucATx){c=true}}if(c&&m_IdtApi.CallBack.onCallInd){m_IdtApi.CallBack.onCallInd(IDT.CALL_EVENT_MicInd,b.UsrCtx,b.ucATx)}b.ucLastMic=b.ucATx;return 0};b.MicCtrl=function(){if(false==b.bUserNotify){return 0}if(false==b.bConnected){return 0}if(b.bUserWantMic){if(0==b.ucATx||IDT.SRV_INFO_MICREL==b.ucLastMicReq){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Send MicReq");b.UserSendInfo(IDT.SRV_INFO_MICREQ,"");b.ucLastMicReq=IDT.SRV_INFO_MICREQ}}else{if(b.ucATx||IDT.SRV_INFO_MICREQ==b.ucLastMicReq){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Send MicRel");b.UserSendInfo(IDT.SRV_INFO_MICREL,"");b.ucLastMicReq=IDT.SRV_INFO_MICREL}}return 0};b.ProcPeerMsg=function(c){if(false==b.bInit){return -1}b.iHBCount=0;switch(c.MsgCode){case IDT.MSG_CC_SETUP:b.RecvSetupProc(c);break;case IDT.MSG_CC_SETUPACK:b.RecvSetupAckProc(c);break;case IDT.MSG_CC_ALERT:b.RecvAlertProc(c);break;case IDT.MSG_CC_CONN:b.RecvConnProc(c);break;case IDT.MSG_CC_CONNACK:b.RecvConnAckProc(c);break;case IDT.MSG_CC_INFO:b.RecvInfoProc(c);break;case IDT.MSG_CC_INFOACK:b.RecvInfoAckProc(c);break;case IDT.MSG_CC_MODIFY:b.RecvModifyProc(c);break;case IDT.MSG_CC_MODIFYACK:b.RecvModifyAckProc(c);break;case IDT.MSG_CC_REL:b.RecvRelProc(c);break;case IDT.MSG_CC_RLC:b.RecvRlcProc(c);break;case IDT.MSG_CC_HB:b.RecvHBProc(c);break;case IDT.MSG_CC_CONFSTATUSRSP:b.RecvConfStatusRspProc(c);break;default:break}return 0};b.TmHB=function(){if(null==b.bInit){return 0}PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"TmHBExpire");b.iHBCount++;if(b.iHBCount>=3){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"TmHB_Disc");b.Rel(IDT.CLOSE_BYINNER,IDT.CAUSE_EXPIRE_IDT+IDT.CPTM_CC_HB*256+IDT.CAUSE_TIMER_EXPIRY)}else{m_IdtApi.McLink.SendJson({MsgCode:IDT.MSG_HB,SrcFsm:b.uiMyId,DstFsm:b.uiPeerFsmId});PUtility.Log("CWsLink",PUtility.PGetCurTime(),"Start TmHB",b.CPTM_CC_HB_LEN);b.TimerHB=setTimeout(b.TmHB,b.CPTM_CC_HB_LEN)}};b.TmSetupAck=function(){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"TmSetupAck");b.Rel(IDT.CLOSE_BYINNER,IDT.CAUSE_EXPIRE_IDT+IDT.CPTM_CC_SETUPACK*256+IDT.CAUSE_TIMER_EXPIRY)};b.TmConn=function(){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"TmConn");b.Rel(IDT.CLOSE_BYINNER,IDT.CAUSE_EXPIRE_IDT+IDT.CPTM_CC_CONN*256+IDT.CAUSE_TIMER_EXPIRY)};b.TmAnswer=function(){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"TmAnswer");b.Rel(IDT.CLOSE_BYINNER,IDT.CAUSE_EXPIRE_IDT+IDT.CPTM_CC_ANSWER*256+IDT.CAUSE_TIMER_EXPIRY)};b.TmConnAck=function(){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"TmConnAck");b.Rel(IDT.CLOSE_BYINNER,IDT.CAUSE_EXPIRE_IDT+IDT.CPTM_CC_CONNACK*256+IDT.CAUSE_TIMER_EXPIRY)};b.TmPress=function(){PUtility.Log("CCFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"TmPress",b.bPressUserWant);b.bUserNotify=true;b.bUserWantMic=b.bPressUserWant;b.ucLastMic=b.ucATx;b.MicCtrl();b.MicInd(true);if(null!=b.TimerPress){clearTimeout(b.TimerPress);b.TimerPress=null}}}return a});(function(b,a){if(typeof define==="function"&&define.amd){define([],a)}else{if(typeof module!=="undefined"&&module.exports){module.exports=a()}else{b.FsmMgr=a()}}})(this,function(){function a(){var b=this;b.ModuleName=null;b.bInit=false;b.iMaxFsm=0;b.Fsm=[];b.Init=function(){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Init");b.bInit=true;return 0};b.ClearRun=function(){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"ClearRun");var c;for(c=0;c<b.iMaxFsm;c++){if(null!=b.Fsm[c]){if(true==b.Fsm[c].bInit){b.Fsm[c].ClearRun()}}}return 0};b.Start=function(f,e,d){b.ModuleName=f;PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Start");if(true==b.bInit){if(b.iMaxFsm==e){return 0}b.Exit()}b.Init();b.iMaxFsm=e;var c;for(c=0;c<e;c++){b.Fsm[c]=new d();b.Fsm[c].uiMyId=c}b.bInit=true;return 0};b.Exit=function(){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Exit");b.ClearRun();var c;for(c=0;c<b.iMaxFsm;c++){if(null!=b.Fsm[c]){b.Fsm[c]=null}}b.iMaxFsm=null;b.bInit=null;return 0};b.Alloc=function(){var c;for(c=0;c<b.iMaxFsm;c++){if(null!=b.Fsm[c]){if(false==b.Fsm[c].bInit){b.Fsm[c].bInit=true;PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Alloc=",c);return c}}}PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Alloc=-1");return -1};b.Remove=function(c){var d;for(d=c;d<b.iMaxFsm;d++){if(d+1>=b.iMaxFsm){b.Fsm[d].ClearRun();break}if(false==b.Fsm[d].bInit){b.Fsm[d].ClearRun();break}b.Fsm[d]=b.Fsm[d+1]}PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Remove=",c);return 0}}return a});"use strict";(function(b,a){if(typeof define==="function"&&define.amd){define([],a)}else{if(typeof module!=="undefined"&&module.exports){module.exports=a()}else{b.CIdtApi=a()}}})(this,function(){function a(){var b=this;b.bInit=false;b.strSrvUrl=null;b.strUserId=null;b.strUserPwd=null;b.strUserNum=null;b.strUserName=null;b.McLink=null;b.strGpsSrvUrl=null;b.strStunServer=null;b.GsLink=null;b.strGpsServer=null;b.strFtpServer=null;b.strFtpUser=null;b.strFtpPwd=null;b.strTaskInfo=null;b.MyOrg=null;b.UsrType=null;b.UsrAttr=null;b.Token=null;b.CallBack=null;b.TransMgr=null;b.CC=null;b.LocalStream=null;b.GUSubsTable=null;b.GpsSubsTable=null;b.ScanTimer=null;b.GUScanPos=null;b.GpsScanPos=null;b.GotStream=function(c){PUtility.Log("IdtApi",PUtility.PGetCurTime(),"Got local stream");b.LocalStream=c};b.Start=function(h,g,e,j,d,c,f,i){if(IDT.RUN_MODE_DEBUG==IDT.RUN_MODE){PUtility.Log=console.log}else{PUtility.Log=PUtility.Log1}if(true==b.bInit){if(b.strSrvUrl==h&&b.strUserId==g&&b.strUserPwd==e){return 0}b.Exit()}b.strSrvUrl=h;b.strUserId=g;b.strUserPwd=e;b.CallBack=i;b.strStunServer=b.strSrvUrl.split("//")[1];b.strStunServer=b.strStunServer.split(":")[0];b.strStunServer="stun:"+b.strStunServer+":10101";b.McLink=new CWsLink();b.McLink.Start("McLink",h,true,g,e,b.CallBack.onStatusInd,b.onWsLinkMcMessage,b.CallBack.onSendMsgHook);b.TransMgr=new FsmMgr();b.TransMgr.Start("TransMgr",j,TransFsm);b.CC=new FsmMgr();b.CC.Start("CCMgr",d,CCFsm);navigator.mediaDevices.getUserMedia({audio:true,video:true}).then(b.GotStream);b.GUSubsTable=new FsmMgr();b.GUSubsTable.Start("StatusSubsMgr",c,SubsFsm);b.GpsSubsTable=new FsmMgr();b.GpsSubsTable.Start("GpsSubsMgr",f,SubsFsm);b.ScanTimer=setTimeout(b.TmScan,1000);b.GUScanPos=0;b.GpsScanPos=0;b.bInit=true;return 0};b.Exit=function(){if(false==b.bInit){return 0}b.McLink.Exit();b.McLink=null;if(null!=b.CallBack.onStatusInd){b.CallBack.onStatusInd(0,IDT.CAUSE_ZERO)}if(null!=b.GsLink){b.GsLink.Exit();b.GsLink=null}b.CC.Exit();try{b.LocalStream.getAudioTracks()[0].stop()}catch(c){}try{b.LocalStream.getVideoTracks()[0].stop()}catch(c){}if(null!=b.ScanTimer){PUtility.Log("IdtApi",PUtility.PGetCurTime(),"Stop ScanTimer");clearTimeout(b.ScanTimer);b.ScanTimer=null}b.GUSubsTable.Exit();b.GpsSubsTable.Exit();b.strSrvUrl=null;b.strUserId=null;b.strUserPwd=null;b.strUserNum=null;b.strUserName=null;b.McLink=null;b.strGpsSrvUrl=null;b.strStunServer=null;b.GsLink=null;b.strGpsServer=null;b.strFtpServer=null;b.strFtpUser=null;b.strFtpPwd=null;b.strTaskInfo=null;b.MyOrg=null;b.UsrType=null;b.UsrAttr=null;b.Token=null;b.CallBack=null;b.TransMgr=null;b.CC=null;b.LocalStream=null;b.GUSubsTable=null;b.GpsSubsTable=null;b.ScanTimer=null;b.GUScanPos=null;b.GpsScanPos=null;b.LocalStream=null;b.GUSubsTable=null;b.GpsSubsTable=null;b.GUScanPos=null;b.GpsScanPos=null;b.bInit=null;return 0};b.ClearAllStatusSubs=function(e,g){var d,f;var c="[";for(d=0,f=0;d<e.iMaxFsm;d++){if(null==e.Fsm[d]){break}if(true!=e.Fsm[d].bInit){break}if(0==f){c+=('{"Num":'+e.Fsm[d].Num+',"Level":'+IDT.GU_STATUSSUBS_NONE+"}")}else{c+=(',{"Num":'+e.Fsm[d].Num+',"Level":'+IDT.GU_STATUSSUBS_NONE+"}")}e.Fsm[d].ClearRun();f++}c+="]";if(f<=0){return 0}var h=JSON.parse(c);g.SendJson({MsgCode:IDT.MSG_MM_STATUSSUBS,MsgBody:{UsrNum:b.strUserNum,SN:1,StatusSubs:h}});return 0};b.SendStatusSubsOne=function(e,c,f,d){if(null==c||""==c){return -1}e.SendJson({MsgCode:IDT.MSG_MM_STATUSSUBS,MsgBody:{UsrNum:b.strUserNum,SN:d,StatusSubs:[{Num:c,Level:f}]}});return 0};b.SendStatusSubs=function(h,g,d,c,l){if(null==h||null==g||d<0||c>g.iMaxFsm||c<d||c-d>IDT.GU_STATUSSUBS_MAXNUM){return -1}var k={};k.MsgCode=IDT.MSG_MM_STATUSSUBS;k.MsgBody={};k.MsgBody.UsrNum=b.strUserNum;k.MsgBody.SN=l;var f,e;k.MsgBody.StatusSubs=[];for(f=d,e=0;f<c;f++,e++){if(false==g.Fsm[f].bInit){break}k.MsgBody.StatusSubs[e]={};k.MsgBody.StatusSubs[e].Num=g.Fsm[f].Num;k.MsgBody.StatusSubs[e].Level=g.Fsm[f].Level}if(e<=0){return -1}h.SendJson(k);return 0};b.TableSubs=function(d,g,f,c,h){PUtility.Log("IdtApi",PUtility.PGetCurTime(),d,c,h);if(null==c||""==c){return -1}if(null==h||h<IDT.GU_STATUSSUBS_NONE||h>IDT.GU_STATUSQUERY_MAX){return -1}if(c==IDT.GU_STATUSSUBS_STR_CLEARALL){b.ClearAllStatusSubs(g,f);return 0}if(c==IDT.GU_STATUSSUBS_STR_ALL){b.ClearAllStatusSubs(g,f)}var e;for(e=0;e<g.iMaxFsm;e++){if(false==g.Fsm[e].bInit){break}if(c==g.Fsm[e].Num){g.Fsm[e].Level=h;if(IDT.GU_STATUSSUBS_NONE==h){g.Remove(e)}b.SendStatusSubsOne(f,c,h,1);return 0}}if(e>=g.iMaxFsm){return -1}if(IDT.GU_STATUSSUBS_NONE==h){return 0}g.Fsm[e].bInit=true;g.Fsm[e].Num=c;g.Fsm[e].Level=h;PUtility.Log(g.ModuleName,PUtility.PGetCurTime(),"Alloc=",e);b.SendStatusSubsOne(f,c,h,1);return 0};b.StatusSubs=function(c,d){return b.TableSubs("StatusSubs",b.GUSubsTable,b.McLink,c,d)};b.GpsSubs=function(c,d){if(IDT.GU_STATUSSUBS_STR_ALL==c||IDT.GU_STATUSSUBS_STR_GROUP==c){return -1}return b.TableSubs("GpsSubs",b.GpsSubsTable,b.GsLink,c,d)};b.GpsReport=function(c,e,h,d,g,f){if(null==c){c=b.strUserNum}b.GsLink.SendJson({MsgCode:IDT.MSG_MM_GPSREPORT,MsgBody:{GpsRecStr:{Num:c,Status:1,Count:1,GpsInfo:[{Longitude:e,Latitude:h,Speed:d,Direction:g,Time:f}]}}});return 0};b.GpsHisQuery=function(d,f,e,c){b.GsLink.SendJson({MsgCode:IDT.MSG_MM_GPSHISQUERYREQ,MsgBody:{UsrNum:d,SN:f,GpsQueryExt:{EndFlag:0,Page:0,Count:IDT.GPS_REC_MAX,StartTime:e,EndTime:c}}});return 0};b.TmScan=function(){b.ScanTimer=setTimeout(b.TmScan,1000);var e,d=0,c=0,f=Math.floor(b.GpsSubsTable.iMaxFsm/20);d=b.GpsScanPos*f;if(((b.GpsScanPos+1)*f)>=b.GpsSubsTable.iMaxFsm){c=b.GpsSubsTable.iMaxFsm}else{c=(b.GpsScanPos+1)*f}PUtility.Log("IdtApi",PUtility.PGetCurTime(),"GpsScan",d,"~",c);for(e=d;e<c;e+=IDT.GU_STATUSSUBS_MAXNUM){if(e+IDT.GU_STATUSSUBS_MAXNUM<c){if(0!=b.SendStatusSubs(b.GsLink,b.GpsSubsTable,e,e+IDT.GU_STATUSSUBS_MAXNUM,0)){break}PUtility.Log("IdtApi",PUtility.PGetCurTime(),"GpsScanSend",e,"~",e+IDT.GU_STATUSSUBS_MAXNUM)}else{if(0!=b.SendStatusSubs(b.GsLink,b.GpsSubsTable,e,c,0)){break}PUtility.Log("IdtApi",PUtility.PGetCurTime(),"GpsScanSend",e,"~",c)}}if((b.GpsScanPos*f)>=b.GpsSubsTable.iMaxFsm){b.GpsScanPos=0}else{b.GpsScanPos++}b.GUScanPos++;if(b.GUScanPos>=20){b.GUScanPos=0;b.SendStatusSubs(b.McLink,b.GUSubsTable,0,b.GUSubsTable.iMaxFsm,0);PUtility.Log("IdtApi",PUtility.PGetCurTime(),"GUScanSend",0,"~",b.GUSubsTable.iMaxFsm)}return 0};b.OamPreProc=function(d){if(null==d){return -1}if(false==b.bInit||3!=b.McLink.Status){d(false,IDT.CAUSE_LINK_DISC,null);return -1}var c=b.TransMgr.Alloc();if(c<0){d(false,IDT.CAUSE_TEMPORARY_FAILURE,null);return -1}b.TransMgr.Fsm[c].Start(d);return c};b.OAdd=function(e,d){var c=b.OamPreProc(d);if(c<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_O_ADD,InvokeNum:b.strUserNum,OpSN:c,OrgListMgr:[e]}});return 0};b.ODel=function(e,d){var c=b.OamPreProc(d);if(c<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_O_DEL,InvokeNum:b.strUserNum,OpSN:c,OrgListMgr:[{Num:e,Name:"",Type:0,Desc:"",UserNum:0,DsNum:0,GNum:0,EUNum:0,DS0Num:"",DS0Pwd:"",DSName:"",DsIcon:"",AppName:"",AppIcon:"",USegStart:"",USegEnd:"",GSegStart:"",GSegEnd:"",DSSegStart:"",DSSegEnd:"",StartTime:"",EndTime:""}]}});return 0};b.OModify=function(e,d){var c=b.OamPreProc(d);if(c<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_O_MODIFY,InvokeNum:b.strUserNum,OpSN:c,OrgListMgr:[e]}});return 0};b.OQuery=function(e,d){var c=b.OamPreProc(d);if(c<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_O_QUERY,InvokeNum:b.strUserNum,OpSN:c,OrgListMgr:[{Num:e,Name:"",Type:0,Desc:"",UserNum:0,DsNum:0,GNum:0,EUNum:0,DS0Num:"",DS0Pwd:"",DSName:"",DsIcon:"",AppName:"",AppIcon:"",USegStart:"",USegEnd:"",GSegStart:"",GSegEnd:"",DSSegStart:"",DSSegEnd:"",StartTime:"",EndTime:""}]}});return 0};b.UAdd=function(f,e,d){var c=b.OamPreProc(d);if(c<0){return -1}f.OpCode=IDT.OPT_USER_ADD;f.InvokeNum=b.strUserNum;f.OpSN=c;f.GNumU=e;b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:f});return 0};b.UDel=function(f,e,d){var c=b.OamPreProc(d);if(c<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_USER_DEL,InvokeNum:b.strUserNum,OpSN:c,UsrNum:f,GNumU:e}});return 0};b.UModify=function(e,d){var c=b.OamPreProc(d);if(c<0){return -1}e.OpCode=IDT.OPT_USER_MODIFY;e.InvokeNum=b.strUserNum;e.OpSN=c;b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:e});return 0};b.UQuery=function(e,d){var c=b.OamPreProc(d);if(c<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_USER_QUERY,InvokeNum:b.strUserNum,OpSN:c,UsrNum:e}});return 0};b.GAdd=function(f,c,g,e){var d=b.OamPreProc(e);if(d<0){return -1}f.OpCode=IDT.OPT_G_ADD;f.InvokeNum=b.strUserNum;f.OpSN=d;if(null!=c){f.UsrGInfo=c}if(null!=g){f.GMember=g}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:f});return 0};b.GDel=function(e,d){var c=b.OamPreProc(d);if(c<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_G_DEL,InvokeNum:b.strUserNum,OpSN:c,GNum:e}});return 0};b.GModify=function(e,d){var c=b.OamPreProc(d);if(c<0){return -1}e.OpCode=IDT.OPT_G_MODIFY;e.InvokeNum=b.strUserNum;e.OpSN=c;b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:e});return 0};b.GQuery=function(e,d){var c=b.OamPreProc(d);if(c<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_G_QUERY,InvokeNum:b.strUserNum,OpSN:c,GNum:e,QueryExt:{All:0,Group:0,User:0,Order:0,Page:0,Count:0,TotalCount:0}}});return 0};b.GQueryU=function(e,d){var c=b.OamPreProc(d);if(c<0){return -1}e.OpCode=IDT.OPT_G_QUERYUSER;e.InvokeNum=b.strUserNum;e.OpSN=c;b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:e});return 0};b.UQueryG=function(c,e){var d=b.OamPreProc(e);if(d<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_U_QUERYGROUP,InvokeNum:b.strUserNum,OpSN:d,UsrNum:c}});return 0};b.GAddU=function(h,g,f,c,e){var d=b.OamPreProc(e);if(d<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_G_ADDUSER,InvokeNum:b.strUserNum,OpSN:d,GNum:h,GMember:[{Prio:c,Type:f,UTType:0,Attr:0,Num:g,Name:"",AGNum:"",ChanNum:0,Status:0,FGCount:0,FGNum:""}]}});return 0};b.GDelU=function(f,c,e){var d=b.OamPreProc(e);if(d<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_G_DELUSER,InvokeNum:b.strUserNum,OpSN:d,GNum:f,UsrNum:c}});return 0};b.GModifyU=function(h,g,f,c,e){var d=b.OamPreProc(e);if(d<0){return -1}b.McLink.SendJson({MsgCode:IDT.MSG_OAM_REQ,MsgBody:{OpCode:IDT.OPT_G_MODIFYUSER,InvokeNum:b.strUserNum,OpSN:d,GNum:h,GMember:[{Prio:c,Type:f,UTType:0,Attr:0,Num:g,Name:"",AGNum:"",ChanNum:0,Status:0,FGCount:0,FGNum:""}]}});return 0};b.IMSend=function(e,c,h,f,d,g){b.McLink.SendJson({MsgCode:IDT.MSG_MM_PASSTHROUGH,MsgBody:{MyNum:b.strUserNum,PeerNum:h,ImInfo:{Code:1,Type:c,UtSn:e,From:b.strUserNum,To:"",OriTo:h,Txt:f,FileName:d,SourceFileName:g}}});return 0};b.CallCheckFsm=function(c){if(null==c||c<0||c>=b.CC.iMaxFsm){return -1}if(false==b.CC.Fsm[c].m_bInit){return -1}return 0};b.CallMakeOut=function(m,p,n,f,k,o,d,e,j,c,h,l){var g;g=b.CC.Alloc();if(g<0){return -1}if(0==b.CC.Fsm[g].CallMakeOut(m,p,n,f,k,o,d,b.strUserNum,e,j,c,h,l)){return g}else{return -1}};b.CallAnswer=function(c,j,f,e,d,h,g,i){if(0!=b.CallCheckFsm(c)){return -1}b.CC.Fsm[c].UserAnswer(j,f,e,d,h,g,i);return 0};b.CallRel=function(c,e,d){if(0!=b.CallCheckFsm(c)){return -1}b.CC.Fsm[c].Rel(IDT.CLOSE_BYUSER,d);return 0};b.CallSetPeerVolume=function(c,d){if(0!=b.CallCheckFsm(c)){return -1}if(null==b.CC.Fsm[c].idPeerV){return -1}try{b.CC.Fsm[c].idPeerV.volume=d}catch(f){PUtility.Log("IdtApi",PUtility.PGetCurTime(),f);return -1}return 0};b.CallSendNum=function(c,d){if(0!=b.CallCheckFsm(c)){return -1}return 0};b.CallMicCtrl=function(c,d){if(0!=b.CallCheckFsm(c)){return -1}b.CC.Fsm[c].CallMicCtrl(d)};b.CallUserCtrl=function(g,i,d,c,f,e,h){return b.McLink.SendJson({MsgCode:IDT.MSG_CC_USERCTRL,MsgBody:{CallUserCtrl:{CallRef:g,Num:i,Op:d,AudioRecv:c,AudioSend:f,VideoRecv:e,VideoSend:h}}})};b.CallConfStatusReq=function(d,c){return b.McLink.SendJson({MsgCode:IDT.MSG_CC_CONFSTATUSREQ,MsgBody:{MyNum:d,OpSn:c}})};b.CallConfCtrlReq=function(c,f,g,e){if(0!=b.CallCheckFsm(c)){return -1}var d=e*256+g;return b.McLink.SendJson({MsgCode:IDT.MSG_CC_INFO,SrcFsm:b.CC.Fsm[c].uiMyId,DstFsm:b.CC.Fsm[c].uiPeerFsmId,MsgBody:{UsrNum:f,Info:{Info:d,InfoStr:f}}})};b.CallSendInfo=function(c,d,e){if(0!=b.CallCheckFsm(c)){return -1}return b.McLink.SendJson({MsgCode:IDT.MSG_CC_INFO,SrcFsm:b.CC.Fsm[c].uiMyId,DstFsm:b.CC.Fsm[c].uiPeerFsmId,MsgBody:{Info:{Info:d,InfoStr:strNum}}})};b.ForceRel=function(c){return b.McLink.SendJson({MsgCode:IDT.MSG_CC_INFO,MsgBody:{MyNum:b.strUserNum,PeerNum:c,SrvType:IDT.SRV_TYPE_FORCE_REL}})};b.onWsLinkGpsStatus=function(c,e){PUtility.Log("IdtApi",PUtility.PGetCurTime(),"onWsLinkGpsStatus",c,e);b.GpsScanPos=0;if(IDT.UT_STATUS_ONLINE!=c){return 0}var d;for(d=0;d<b.GpsSubsTable.iMaxFsm;d++){if(false==b.GpsSubsTable.Fsm[d].bInit){break}b.SendStatusSubsOne(b.GsLink,b.GpsSubsTable.Fsm[d].Num,b.GpsSubsTable.Fsm[d].Level,1)}return 0};b.onWsLinkGsMessage=function(d){var c;if(b.CallBack.onRecvMsgHook&&IDT.RUN_MODE_DEBUG==IDT.RUN_MODE){b.CallBack.onRecvMsgHook("GsLink",d)}switch(d.MsgCode){case IDT.MSG_MM_GPSRECIND:if(null!=b.CallBack.onGpsRecInd){b.CallBack.onGpsRecInd(d.MsgBody.GpsRecStr)}break;case IDT.MSG_MM_GPSHISQUERYRSP:if(b.CallBack.onGpsHisQueryInd){b.CallBack.onGpsHisQueryInd(d.MsgBody.UsrNum,d.MsgBody.SN,d.MsgBody.GpsQueryExt.EndFlag,d.MsgBody.GpsRecStr)}if(1==d.MsgBody.GpsQueryExt.EndFlag){break}b.GsLink.SendJson({MsgCode:IDT.MSG_MM_GPSHISQUERYREQ,MsgBody:{UsrNum:d.MsgBody.UsrNum,SN:d.MsgBody.SN,GpsQueryExt:d.MsgBody.GpsQueryExt}});break;default:break}return 0};b.onWsLinkMcMessage=function(d){var c;if(b.CallBack.onRecvMsgHook&&IDT.RUN_MODE_DEBUG==IDT.RUN_MODE){b.CallBack.onRecvMsgHook("McLink",d)}switch(d.MsgCode){case IDT.MSG_MM_REGRSP:if(0!=d.MsgBody.Result){break}b.strUserNum=d.MsgBody.UsrNum;if(b.strGpsSrvUrl!=d.MsgBody.GpsServerInfo){b.strGpsSrvUrl="ws://"+d.MsgBody.GpsServerInfo;if(null!=b.GsLink){b.GsLink.Exit();b.GsLink=null}b.GsLink=new CWsLink();b.GsLink.Start("GsLink",b.strGpsSrvUrl,false,null,null,b.onWsLinkGpsStatus,b.onWsLinkGsMessage,b.CallBack.onSendMsgHook)}if(null!=d.MsgBody.FtpServerInfo){b.strFtpServer=d.MsgBody.FtpServerInfo.IPAddr;b.strFtpUser=d.MsgBody.FtpServerInfo.Name;b.strFtpPwd=d.MsgBody.FtpServerInfo.Pwd}if(null!=d.MsgBody.GpsServerInfo){b.strGpsServer=d.MsgBody.GpsServerInfo}if(null!=d.MsgBody.TaskServerInfo){b.strTaskInfo=d.MsgBody.TaskServerInfo}if(null!=d.MsgBody.OrgList){b.MyOrg=d.MsgBody.OrgList[0]}if(null!=d.MsgBody.UserType){b.UsrType=d.MsgBody.UserType}if(null!=d.MsgBody.UserAttr){b.UsrAttr=d.MsgBody.UserAttr}if(null!=d.MsgBody.UsrName){b.strUserName=d.MsgBody.UsrName}if(null!=d.MsgBody.UsrNum){b.strUserNum=d.MsgBody.UsrNum}else{b.strUserNum=b.strUserId}b.Token=b.McLink.strAuthRsp;if(b.CallBack.onGInfoInd){b.CallBack.onGInfoInd(d.MsgBody.UsrGInfo)}break;case IDT.MSG_MM_STATUSNOTIFY:if(b.CallBack.onGUStatusInd){b.CallBack.onGUStatusInd(d.MsgBody.GMemberStatus)}if(0==d.MsgBody.SN||null==d.MsgBody.UsrNum||null==d.MsgBody.StatusSubs){break}if(IDT.GU_STATUSSUBS_NONE==d.MsgBody.StatusSubs[0].Level){break}for(c=0;c<b.GUSubsTable.iMaxFsm;c++){if(false==b.GUSubsTable.Fsm[c].m_bInit){break}if(d.MsgBody.StatusSubs[0].Num==b.GUSubsTable.Fsm[c].Num){b.SendStatusSubsOne(b.McLink,b.GUSubsTable.Fsm[c].Num,b.GUSubsTable.Fsm[c].Level,d.MsgBody.SN);break}}break;case IDT.MSG_MM_PASSTHROUGH:if(1==d.MsgBody.ImInfo.Code){b.McLink.SendJson({MsgCode:IDT.MSG_MM_PASSTHROUGH,MsgBody:{MyNum:d.MsgBody.PeerNum,PeerNum:d.MsgBody.MyNum,ImInfo:{Code:2,Type:d.MsgBody.ImInfo.Type,UtSn:d.MsgBody.ImInfo.UtSn,Sn:d.MsgBody.ImInfo.Sn}}});if(b.CallBack.onIMRecv){b.CallBack.onIMRecv(d.MsgBody.ImInfo.Sn,d.MsgBody.ImInfo.Type,d.MsgBody.ImInfo.From,d.MsgBody.ImInfo.To,d.MsgBody.ImInfo.OriTo,d.MsgBody.ImInfo.Txt,d.MsgBody.ImInfo.FileName,d.MsgBody.ImInfo.SourceFileName,d.MsgBody.ImInfo.Time)}}else{if(3==d.MsgBody.ImInfo.Code){b.McLink.SendJson({MsgCode:IDT.MSG_MM_PASSTHROUGH,MsgBody:{MyNum:d.MsgBody.PeerNum,PeerNum:d.MsgBody.MyNum,ImInfo:{Code:4,Type:d.MsgBody.ImInfo.Type,UtSn:d.MsgBody.ImInfo.UtSn,Sn:d.MsgBody.ImInfo.Sn}}})}}break;case IDT.MSG_OAM_RSP:c=d.MsgBody.OpSN;if(c<0||c>b.TransMgr.iMaxFsm){break}if(true!=b.TransMgr.Fsm[c].bInit){break}if(null!=b.TransMgr.Fsm[c].pfCallBack){switch(d.MsgBody.OpCode){case IDT.OPT_O_QUERY:if(0==d.MsgBody.Cause){b.TransMgr.Fsm[c].pfCallBack(true,d.MsgBody.Cause,null,d.MsgBody)}else{b.TransMgr.Fsm[c].pfCallBack(false,d.MsgBody.Cause,null,d.MsgBody)}break;case IDT.OPT_USER_QUERY:case IDT.OPT_G_QUERY:case IDT.OPT_G_QUERYUSER:case IDT.OPT_U_QUERYGROUP:if(0==d.MsgBody.Cause){b.TransMgr.Fsm[c].pfCallBack(true,d.MsgBody.Cause,null,d.MsgBody)}else{b.TransMgr.Fsm[c].pfCallBack(false,d.MsgBody.Cause,null,d.MsgBody)}break;default:if(0==d.MsgBody.Cause){b.TransMgr.Fsm[c].pfCallBack(true,d.MsgBody.Cause,null,d.MsgBody)}else{b.TransMgr.Fsm[c].pfCallBack(false,d.MsgBody.Cause,d.MsgBody.CauseStr,d.MsgBody)}break}}b.TransMgr.Fsm[c].ClearRun();break;case IDT.MSG_OAM_NOTIFY:if(null!=b.CallBack.onGUOamInd){b.CallBack.onGUOamInd(d.MsgBody.OpCode,d.MsgBody.GNum,d.MsgBody.GName,d.MsgBody.UsrNum,d.MsgBody.UsrName)}break;case IDT.MSG_CC_SETUP:c=b.CC.Alloc();if(c<0){break}b.CC.Fsm[c].ProcPeerMsg(d);break;case IDT.MSG_CC_SETUPACK:case IDT.MSG_CC_ALERT:case IDT.MSG_CC_CONN:case IDT.MSG_CC_CONNACK:case IDT.MSG_CC_INFO:case IDT.MSG_CC_INFOACK:case IDT.MSG_CC_MODIFY:case IDT.MSG_CC_MODIFYACK:case IDT.MSG_CC_REL:case IDT.MSG_CC_RLC:case IDT.MSG_CC_USERCTRL:case IDT.MSG_CC_STREAMCTRL:case IDT.MSG_CC_CONFSTATUSREQ:c=d.DstFsm;if(null==c||c<0||c>=b.CC.iMaxFsm){break}b.CC.Fsm[c].ProcPeerMsg(d);break;case IDT.MSG_CC_CONFSTATUSRSP:if(b.CallBack.onCallInd){b.CallBack.onCallInd(IDT.CALL_EVENT_ConfStatusRsp,0,d.MsgBody)}break;case IDT.MSG_HB:if(null==d.SrcFsm||null==d.DstFsm){break}if(4294967295!=d.SrcFsm||4294967295!=d.DstFsm){c=d.DstFsm;if(null==c||c<0||c>=b.CC.iMaxFsm){break}b.CC.Fsm[c].ProcPeerMsg(d)}break;default:break}return 0}}return a});var PUtility={};PUtility.str_utf8_length=function(a){return unescape(encodeURIComponent(a)).length};PUtility.isFunction=function(a){if(a!==undefined){return(Object.prototype.toString.call(a)==="[object Function]")?true:false}else{return false}};PUtility.isString=function(a){if(a!==undefined){return(Object.prototype.toString.call(a)==="[object String]")?true:false}else{return false}};PUtility.isDecimal=function(a){return !isNaN(a)&&(parseFloat(a)===parseInt(a,10))};PUtility.isEmpty=function(a){if(a===null||a===""||a===undefined||(Array.isArray(a)&&a.length===0)||(typeof(a)==="number"&&isNaN(a))){return true}};PUtility.hasMethods=function(c){var b=1,a;while((a=arguments[b++])){if(this.isFunction(c[a])){return false}}return true};PUtility.newUUID=function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=Math.random()*16|0,b=e==="x"?d:(d&3|8);return b.toString(16)});return a};PUtility.calculateMD5=function(n){function w(b,a){return(b<<a)|(b>>>(32-a))}function G(k,b){var V,a,d,x,c;d=(k&2147483648);x=(b&2147483648);V=(k&1073741824);a=(b&1073741824);c=(k&1073741823)+(b&1073741823);if(V&a){return(c^2147483648^d^x)}if(V|a){if(c&1073741824){return(c^3221225472^d^x)}else{return(c^1073741824^d^x)}}else{return(c^d^x)}}function v(a,c,b){return(a&c)|((~a)&b)}function u(a,c,b){return(a&b)|(c&(~b))}function t(a,c,b){return(a^c^b)}function r(a,c,b){return(c^(a|(~b)))}function D(W,V,aa,Z,k,X,Y){W=G(W,G(G(v(V,aa,Z),k),Y));return G(w(W,X),V)}function o(W,V,aa,Z,k,X,Y){W=G(W,G(G(u(V,aa,Z),k),Y));return G(w(W,X),V)}function R(W,V,aa,Z,k,X,Y){W=G(W,G(G(t(V,aa,Z),k),Y));return G(w(W,X),V)}function C(W,V,aa,Z,k,X,Y){W=G(W,G(G(r(V,aa,Z),k),Y));return G(w(W,X),V)}function e(k){var W;var d=k.length;var c=d+8;var b=(c-(c%64))/64;var V=(b+1)*16;var X=new Array(V-1);var a=0;var x=0;while(x<d){W=(x-(x%4))/4;a=(x%4)*8;X[W]=(X[W]|(k.charCodeAt(x)<<a));x++}W=(x-(x%4))/4;a=(x%4)*8;X[W]=X[W]|(128<<a);X[V-2]=d<<3;X[V-1]=d>>>29;return X}function p(d){var a="",b="",k,c;for(c=0;c<=3;c++){k=(d>>>(c*8))&255;b="0"+k.toString(16);a=a+b.substr(b.length-2,2)}return a}function q(b){b=b.replace(/\r\n/g,"\n");var a="";for(var k=0;k<b.length;k++){var d=b.charCodeAt(k);if(d<128){a+=String.fromCharCode(d)}else{if((d>127)&&(d<2048)){a+=String.fromCharCode((d>>6)|192);a+=String.fromCharCode((d&63)|128)}else{a+=String.fromCharCode((d>>12)|224);a+=String.fromCharCode(((d>>6)&63)|128);a+=String.fromCharCode((d&63)|128)}}}return a}var E=[];var K,g,F,s,f,U,T,S,Q;var N=7,L=12,I=17,H=22;var B=5,A=9,z=14,y=20;var m=4,l=11,j=16,i=23;var P=6,O=10,M=15,J=21;n=q(n);E=e(n);U=1732584193;T=4023233417;S=2562383102;Q=271733878;for(K=0;K<E.length;K+=16){g=U;F=T;s=S;f=Q;U=D(U,T,S,Q,E[K+0],N,3614090360);Q=D(Q,U,T,S,E[K+1],L,3905402710);S=D(S,Q,U,T,E[K+2],I,606105819);T=D(T,S,Q,U,E[K+3],H,3250441966);U=D(U,T,S,Q,E[K+4],N,4118548399);Q=D(Q,U,T,S,E[K+5],L,1200080426);S=D(S,Q,U,T,E[K+6],I,2821735955);T=D(T,S,Q,U,E[K+7],H,4249261313);U=D(U,T,S,Q,E[K+8],N,1770035416);Q=D(Q,U,T,S,E[K+9],L,2336552879);S=D(S,Q,U,T,E[K+10],I,4294925233);T=D(T,S,Q,U,E[K+11],H,2304563134);U=D(U,T,S,Q,E[K+12],N,1804603682);Q=D(Q,U,T,S,E[K+13],L,4254626195);S=D(S,Q,U,T,E[K+14],I,2792965006);T=D(T,S,Q,U,E[K+15],H,1236535329);U=o(U,T,S,Q,E[K+1],B,4129170786);Q=o(Q,U,T,S,E[K+6],A,3225465664);S=o(S,Q,U,T,E[K+11],z,643717713);T=o(T,S,Q,U,E[K+0],y,3921069994);U=o(U,T,S,Q,E[K+5],B,3593408605);Q=o(Q,U,T,S,E[K+10],A,38016083);S=o(S,Q,U,T,E[K+15],z,3634488961);T=o(T,S,Q,U,E[K+4],y,3889429448);U=o(U,T,S,Q,E[K+9],B,568446438);Q=o(Q,U,T,S,E[K+14],A,3275163606);S=o(S,Q,U,T,E[K+3],z,4107603335);T=o(T,S,Q,U,E[K+8],y,1163531501);U=o(U,T,S,Q,E[K+13],B,2850285829);Q=o(Q,U,T,S,E[K+2],A,4243563512);S=o(S,Q,U,T,E[K+7],z,1735328473);T=o(T,S,Q,U,E[K+12],y,2368359562);U=R(U,T,S,Q,E[K+5],m,4294588738);Q=R(Q,U,T,S,E[K+8],l,2272392833);S=R(S,Q,U,T,E[K+11],j,1839030562);T=R(T,S,Q,U,E[K+14],i,4259657740);U=R(U,T,S,Q,E[K+1],m,2763975236);Q=R(Q,U,T,S,E[K+4],l,1272893353);S=R(S,Q,U,T,E[K+7],j,4139469664);T=R(T,S,Q,U,E[K+10],i,3200236656);U=R(U,T,S,Q,E[K+13],m,681279174);Q=R(Q,U,T,S,E[K+0],l,3936430074);S=R(S,Q,U,T,E[K+3],j,3572445317);T=R(T,S,Q,U,E[K+6],i,76029189);U=R(U,T,S,Q,E[K+9],m,3654602809);Q=R(Q,U,T,S,E[K+12],l,3873151461);S=R(S,Q,U,T,E[K+15],j,530742520);T=R(T,S,Q,U,E[K+2],i,3299628645);U=C(U,T,S,Q,E[K+0],P,4096336452);Q=C(Q,U,T,S,E[K+7],O,1126891415);S=C(S,Q,U,T,E[K+14],M,2878612391);T=C(T,S,Q,U,E[K+5],J,4237533241);U=C(U,T,S,Q,E[K+12],P,1700485571);Q=C(Q,U,T,S,E[K+3],O,2399980690);S=C(S,Q,U,T,E[K+10],M,4293915773);T=C(T,S,Q,U,E[K+1],J,2240044497);U=C(U,T,S,Q,E[K+8],P,1873313359);Q=C(Q,U,T,S,E[K+15],O,4264355552);S=C(S,Q,U,T,E[K+6],M,2734768916);T=C(T,S,Q,U,E[K+13],J,1309151649);U=C(U,T,S,Q,E[K+4],P,4149444226);Q=C(Q,U,T,S,E[K+11],O,3174756917);S=C(S,Q,U,T,E[K+2],M,718787259);T=C(T,S,Q,U,E[K+9],J,3951481745);U=G(U,g);T=G(T,F);S=G(S,s);Q=G(Q,f)}var h=p(U)+p(T)+p(S)+p(Q);return h.toLowerCase()};PUtility.AuthMD5_Calc=function(d,i,j,c,e,a,f){var h=PUtility.calculateMD5(d+":"+i+":"+j);var g=PUtility.calculateMD5(c+":"+f);var b=PUtility.calculateMD5(h+":"+a+":"+g);return b};PUtility.PGetCurTime=function(){var c=new Date();var b="-";var a=":";var f=c.getMonth()+1;var e=c.getDate();if(f>=1&&f<=9){f="0"+f}if(e>=0&&e<=9){e="0"+e}var d=c.getFullYear()+b+f+b+e+" "+c.getHours()+a+c.getMinutes()+a+c.getSeconds()+a+c.getMilliseconds();return d};PUtility.m_OrigLog=console.log;PUtility.Log1=function(){if(0==IDT.RUN_MODE){return}PUtility.m_OrigLog.apply(console,arguments)};PUtility.IsValid=function(a){return true};PUtility.RequestFullScreen=function(a){var c=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen||a.msRequestFullScreen;if(c){c.call(a)}else{if(typeof window.ActiveXObject!=="undefined"){var b=new ActiveXObject("WScript.Shell");if(b!==null){b.SendKeys("{F11}")}}}};PUtility.ExitFull=function(){var b=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen||document.webkitExitFullscreen;if(b){b.call(document)}else{if(typeof window.ActiveXObject!=="undefined"){var a=new ActiveXObject("WScript.Shell");if(a!==null){a.SendKeys("{F11}")}}}};(function(b,a){if(typeof define==="function"&&define.amd){define([],a)}else{if(typeof module!=="undefined"&&module.exports){module.exports=a()}else{b.SubsFsm=a()}}})(this,function(){function a(){var b=this;b.uiMyId=null;b.bInit=false;b.Num=null;b.Level=null;b.ClearRun=function(){PUtility.Log("SubsFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"ClearRun");b.Num=null;b.Level=null;b.bInit=false;return 0};b.Start=function(c,d){PUtility.Log("SubsFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Start",c,d);b.Num=c;b.Level=d;b.bInit=true;return 0}}return a});"use strict";(function(b,a){if(typeof define==="function"&&define.amd){define([],a)}else{if(typeof module!=="undefined"&&module.exports){module.exports=a()}else{b.TransFsm=a()}}})(this,function(){function a(){var b=this;b.uiMyId=null;b.bInit=false;b.InvokeTime=null;b.TIMER_LEN=10000;b.Timer=null;b.pfCallBack=null;b.Init=function(){PUtility.Log("TransFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Init");b.ClearRun();return 0};b.ClearRun=function(){PUtility.Log("TransFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"ClearRun");b.InvokeTime=null;b.pfCallBack=null;if(null!=b.Timer){clearTimeout(b.Timer);b.Timer=null}b.bInit=false;return 0};b.TmExp=function(){PUtility.Log("TransFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"TmExp");if(null==b.bInit){return 0}b.Timer=null;if(null!=b.pfCallBack){b.pfCallBack(false,IDT.CAUSE_TIMER_EXPIRY,null)}b.ClearRun()};b.Start=function(c){PUtility.Log("TransFsm[",b.uiMyId,"]",PUtility.PGetCurTime(),"Start");b.bInit=true;b.pfCallBack=c;b.Timer=setTimeout(b.TmExp,b.TIMER_LEN);return 0}}return a});"use strict";(function(b,a){if(typeof define==="function"&&define.amd){define([],a)}else{if(typeof module!=="undefined"&&module.exports){module.exports=a()}else{b.CWsLink=a()}}})(this,function(){function a(){var b=this;b.ModuleName=null;b.bInit=false;b.strPeerUrl=null;b.bNeedReg=false;b.strUserId=null;b.strUserPwd=null;b.onRecvMsg=null;b.onStatus=null;b.m_bFirstStart=true;b.Status=0;b.Link=null;b.strUserNum=null;b.CONNECT_TIMER_LEN=5000;b.TimerConnect=null;b.LOGIN_TIMER_LEN=10000;b.TimerLogin=null;b.HB_TIMER_LEN=5000;b.TimerHB=null;b.iHBCount=0;b.strAuthRsp=null;b.Init=function(){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Init");b.bInit=false;b.strPeerUrl=null;b.bNeedReg=false;b.strUserId=null;b.strUserPwd=null;b.onRecvMsg=null;b.onSendMsg=null;b.onStatus=null;b.m_bFirstStart=true;b.Status=0;b.Link=null;b.strUserNum=null;b.CONNECT_TIMER_LEN=5000;b.TimerConnect=null;b.LOGIN_TIMER_LEN=10000;b.TimerLogin=null;b.HB_TIMER_LEN=5000;b.TimerHB=null;b.iHBCount=0;b.strAuthRsp=null;return 0};b.ClearRun=function(){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"ClearRun");if(null!=b.TimerConnect){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Stop TimerConnect");clearTimeout(b.TimerConnect);b.TimerConnect=null}if(null!=b.TimerLogin){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Stop TimerLogin");clearTimeout(b.TimerLogin);b.TimerLogin=null}if(null!=b.TimerHB){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Stop TimerHB");clearTimeout(b.TimerHB);b.TimerHB=null}if(null!=b.Link){b.Link.close();b.Link=null;PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"LinkClose")}return 0};b.ConnectReq=function(){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"ConnectReq");b.ClearRun();b.SetStatue(1,IDT.CAUSE_ZERO);b.Link=new WebSocket(b.strPeerUrl);b.Link.binaryType="blob";PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"LinkCreate");b.Link.onopen=function(c){b.onWsOpen(c)};b.Link.onclose=function(c){b.onWsClose(c)};b.Link.onmessage=function(c){b.onWsMessage(c)};b.Link.onerror=function(c){b.onWsError(c)};PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Start TmConnect",b.CONNECT_TIMER_LEN);b.TimerConnect=setTimeout(b.TmConnect,b.CONNECT_TIMER_LEN);if(true==b.bNeedReg){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Start TmLogin",b.LOGIN_TIMER_LEN);b.TimerLogin=setTimeout(b.TmLogin,b.LOGIN_TIMER_LEN)}return 0};b.SendJsonInner=function(d){if(1!=b.Link.readyState){return -1}if(null==d.SrcFsm){d.SrcFsm=4294967295}if(null==d.DstFsm){d.DstFsm=4294967295}var c=JSON.stringify(d);b.Link.send(c);if(b.onSendMsg&&IDT.RUN_MODE_DEBUG==IDT.RUN_MODE){b.onSendMsg(b.ModuleName,d)}return 0};b.SendJson=function(c){if(3!=b.Status){return -1}return b.SendJsonInner(c)};b.SetStatue=function(c,d){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Status=",c,IDT.GetCauseStr(d));if(null!=b.onStatus){if(b.m_bFirstStart){if(3==c){b.onStatus(1,d);b.m_bFirstStart=false;PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"onStatus",1)}else{if(0==c){b.onStatus(0,d);b.m_bFirstStart=false;PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"onStatus",0)}}}else{if(3!=b.Status&&3==c){b.onStatus(1,d);PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"onStatus",1)}else{if(3==b.Status&&0==c){b.onStatus(0,d);PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"onStatus",0)}}}}b.Status=c;return 0};b.onWsOpen=function(c){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"onWsOpen");if(null==b.bInit){return 0}if(null!=b.TimerConnect){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Stop TimerConnect");clearTimeout(b.TimerConnect);b.TimerConnect=null}b.SetStatue(2,IDT.CAUSE_ZERO);if(true==b.bNeedReg){b.SendJsonInner({MsgCode:IDT.MSG_MM_REGREQ,MsgBody:{UsrNum:b.strUserNum,RegType:1,AuthAlg:"MD5",AuthRealm:"",AuthNonce:"",AuthRsp:"",ConCurrent:0}});if(null==b.TimerLogin){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Start TmLogin",b.LOGIN_TIMER_LEN);b.TimerLogin=setTimeout(b.TmLogin,b.LOGIN_TIMER_LEN)}}else{if(null!=b.onStatus){b.SetStatue(3,IDT.CAUSE_ZERO)}}PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Start TmHB",b.HB_TIMER_LEN);b.TimerHB=setTimeout(b.TmHB,b.HB_TIMER_LEN);return 0};b.onWsClose=function(c){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"onWsClose");if(null==b.bInit){return 0}return 0};b.onWsMessage=function(c){if(null==b.bInit){return 0}var f={};b.iHBCount=0;var d=c.data.replace(new RegExp("\r\n","g"),"<br/>");var e=d.replace(new RegExp("\\\\","g"),"\\\\");f=JSON.parse(e);if(null!=b.onRecvMsg){b.onRecvMsg(f)}switch(f.MsgCode){case IDT.MSG_MM_REGRSP:PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),IDT.MSG_MM_REGRSP,IDT.GetCauseStr(f.MsgBody.Result));switch(f.MsgBody.Result){case 25:b.strAuthRsp=PUtility.AuthMD5_Calc(f.MsgBody.UsrNum,f.MsgBody.AuthRealm,b.strUserPwd,"REGISTER",f.MsgBody.AuthAlg,f.MsgBody.AuthNonce,"0.0.0.0");b.SendJsonInner({MsgCode:IDT.MSG_MM_REGREQ,MsgBody:{UsrNum:f.MsgBody.UsrNum,RegType:f.MsgBody.RegType,AuthAlg:f.MsgBody.AuthAlg,AuthRealm:f.MsgBody.AuthRealm,AuthNonce:f.MsgBody.AuthNonce,AuthRsp:b.strAuthRsp,ConCurrent:0}});break;case 0:b.SetStatue(3,f.MsgBody.Result);PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Stop TimerLogin");clearTimeout(b.TimerLogin);b.TimerLogin=null;f.MsgBody.AuthRsp=b.strAuthRsp;break;default:b.SetStatue(0,f.MsgBody.Result);b.ClearRun();break}break;default:break}return 0};b.onWsError=function(c){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"onWsError");if(null==b.bInit){return 0}return 0};b.TmConnect=function(){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"TmConnectExpire");if(null==b.bInit){return 0}b.TimerConnect=null;b.SetStatue(0,IDT.CAUSE_ZERO);b.ConnectReq()};b.TmLogin=function(){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"TmLoginExpire");if(null==b.bInit){return 0}b.TimerConnect=null;b.SetStatue(0,IDT.CAUSE_TIMER_EXPIRY);b.ConnectReq()};b.TmHB=function(){if(null==b.bInit){return 0}PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"TmHBExpire");b.iHBCount++;if(b.iHBCount>=3){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"TmHB_Disc");b.TimerConnect=null;b.SetStatue(0,IDT.CAUSE_TIMER_EXPIRY);b.ConnectReq()}else{b.SendJsonInner({MsgCode:IDT.MSG_HB});PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Start TmHB",b.HB_TIMER_LEN);b.TimerHB=setTimeout(b.TmHB,b.HB_TIMER_LEN)}};b.Start=function(j,i,f,d,e,c,g,h){b.ModuleName=j;PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Start");if(true==b.bInit){if(b.strPeerUrl==i&&b.strUserId==d&&b.strUserPwd==e){return 0}b.Exit()}b.Init();b.strPeerUrl=i;b.bNeedReg=f;b.strUserId=d;b.strUserPwd=e;b.onStatus=c;b.onRecvMsg=g;b.onSendMsg=h;b.strUserNum=d;b.ConnectReq();b.bInit=true;return 0};b.Exit=function(){PUtility.Log(b.ModuleName,PUtility.PGetCurTime(),"Exit");b.ClearRun();b.bInit=null;b.strPeerUrl=null;b.bNeedReg=null;b.strUserId=null;b.strUserPwd=null;b.onRecvMsg=null;b.onSendMsg=null;b.onStatus=null;b.m_bFirstStart=null;b.Status=null;b.Link=null;b.strUserNum=null;b.CONNECT_TIMER_LEN=null;b.TimerConnect=null;b.LOGIN_TIMER_LEN=null;b.TimerLogin=null;b.HB_TIMER_LEN=null;b.TimerHB=null;b.iHBCount=null;b.strAuthRsp=null;return 0}}return a});
